<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entertainment Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@700&family=Creepster&family=Inter:wght@400;500;600;700&family=Orbitron:wght@700&family=Poppins:wght@600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@lottiefiles/dotlottie-wc@0.6.2/dist/dotlottie-wc.js" type="module"></script>
    
    <!-- ADDED: Scripts for React -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script>
        tailwind.config = {
            // ... existing tailwind config ...
        }
    </script>
    <style>
        /* ... existing styles ... */
    </style>
</head>
<body class="bg-zinc-900 text-zinc-200">
    <div id="configErrorScreen" class="config-error-screen hidden"></div>

    <div id="loginScreen" class="fixed inset-0 bg-zinc-900 flex flex-col justify-center items-center z-50">
        <!-- ... existing login screen ... -->
    </div>

    <div id="app" class="container mx-auto p-4 md:p-8 hidden">
        
        <header class="text-center mb-8 relative md:px-8">
             <!-- ... existing header ... -->
        </header>

        <div class="mb-8 max-w-2xl mx-auto">
            <!-- ... existing search wrapper ... -->
        </div>

        <div class="mb-8">
            <div class="flex justify-center flex-wrap border-b border-zinc-700">
                <button data-tab="dashboard" class="tab-button flex items-center justify-center gap-2 py-3 px-4 md:px-4 border-b-2 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3h7v7H3zM14 3h7v7h-7zM14 14h7v7h-7zM3 14h7v7H3z"/></svg>
                    <span class="hidden md:inline">Dashboard</span>
                </button>
                <button data-tab="favorites" class="tab-button flex items-center justify-center gap-2 py-3 px-4 md:px-4 border-b-2 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
                    <span class="hidden md:inline">Favorites</span>
                </button>
                <button data-tab="schedule" class="tab-button flex items-center justify-center gap-2 py-3 px-4 md:px-4 border-b-2 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                    <span class="hidden md:inline">Schedule</span>
                </button>
                <!-- ADDED: New Tab for Horror Tracker -->
                <button data-tab="horror-tracker" class="tab-button flex items-center justify-center gap-2 py-3 px-4 md:px-4 border-b-2 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><path d="M8 12h8"></path><path d="M8 16h8"></path></svg>
                    <span class="hidden md:inline">31 Nights</span>
                </button>
                <button data-tab="settings" class="tab-button flex items-center justify-center gap-2 py-3 px-4 md:px-4 border-b-2 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
                    <span class="hidden md:inline">Settings</span>
                </button>
            </div>
        </div>

        <main id="content-area">
            <div id="dashboard" class="tab-content">
                 <!-- ... existing dashboard content ... -->
            </div>

            <div id="search-results" class="tab-content hidden">
                 <!-- ... existing search results content ... -->
            </div>

            <div id="favorites" class="tab-content hidden">
                 <!-- ... existing favorites content ... -->
            </div>

            <div id="schedule" class="tab-content hidden">
                 <!-- ... existing schedule content ... -->
            </div>
            
            <!-- ADDED: Container for the Horror Tracker App -->
            <div id="horror-tracker" class="tab-content hidden">
                <div id="horror-tracker-root"></div>
            </div>

            <div id="settings" class="tab-content hidden">
                 <!-- ... existing settings content ... -->
            </div>
        </main>
        
        <!-- ... existing loading spinner, modals, etc. ... -->
    </div>
    
    <!-- ADDED: This script contains your React component and renders it. -->
    <script type="text/babel">
        // The HorrorTracker component code is placed here directly.
        // --- Helper for CSV Parsing ---
        const Papa = (() => {
            function parse(csv, config) {
                config = config || {};
                const header = config.header;
                const newline = config.newline || '\n';
                const lines = csv.trim().split(newline);
                let results = [];
                const headers = header ? lines[0].split(',') : [];

                for (let i = header ? 1 : 0; i < lines.length; i++) {
                    if (!lines[i]) continue;
                    let values = lines[i].split(',');
                    if (header) {
                        let obj = {};
                        for (let j = 0; j < headers.length; j++) {
                            obj[headers[j].trim()] = values[j] ? values[j].trim() : '';
                        }
                        results.push(obj);
                    } else {
                        results.push(values.map(v => v.trim()));
                    }
                }
                return { data: results };
            }
            return { parse };
        })();

        // --- SVG Icons ---
        const FilmIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm2 2a1 1 0 00-1 1v2a1 1 0 001 1h2a1 1 0 001-1V6a1 1 0 00-1-1H6zm5 0a1 1 0 00-1 1v2a1 1 0 001 1h2a1 1 0 001-1V6a1 1 0 00-1-1h-2zM6 12a1 1 0 00-1 1v2a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 00-1-1H6zm5 0a1 1 0 00-1 1v2a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 00-1-1h-2z" clipRule="evenodd" /></svg>;
        const ListIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" /></svg>;
        const ChartIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M2 11a1 1 0 011-1h2a1 1 0 110 2H3a1 1 0 01-1-1zm5 0a1 1 0 011-1h2a1 1 0 110 2H8a1 1 0 01-1-1zm5 0a1 1 0 011-1h2a1 1 0 110 2h-2a1 1 0 01-1-1z" /><path d="M2 5a1 1 0 011-1h14a1 1 0 110 2H3a1 1 0 01-1-1z" /></svg>;
        const UploadIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clipRule="evenodd" /></svg>;
        const SearchIcon = () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>;

        // --- Reusable Movie Card Component ---
        const MovieCard = ({ movie, onAction, actionText, actionIcon }) => (
            <div className="bg-zinc-800 rounded-lg overflow-hidden shadow-lg transform hover:scale-105 transition-transform duration-300 flex flex-col">
                <img 
                    src={movie.poster_path ? `https://image.tmdb.org/t/p/w500${movie.poster_path}` : 'https://placehold.co/500x750/1f2937/9ca3af?text=No+Image'} 
                    alt={`Poster for ${movie.title}`} 
                    className="w-full h-auto object-cover"
                    onError={(e) => { e.target.onerror = null; e.target.src='https://placehold.co/500x750/1f2937/9ca3af?text=No+Image'; }}
                />
                <div className="p-4 flex flex-col flex-grow">
                    <h3 className="font-bold text-lg text-white mb-2 truncate">{movie.title}</h3>
                    <p className="text-zinc-400 text-sm mb-2">{movie.release_date ? movie.release_date.split('-')[0] : 'N/A'}</p>
                    <p className="text-zinc-300 text-xs flex-grow overflow-y-auto max-h-20">{movie.overview}</p>
                    {onAction && (
                        <button
                            onClick={() => onAction(movie)}
                            className="mt-4 w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center transition-colors"
                        >
                            {actionIcon}
                            {actionText}
                        </button>
                    )}
                </div>
            </div>
        );

        // --- Main Horror Tracker Component ---
        function HorrorTracker({ db, userId, firestore }) {
            const [activeTab, setActiveTab] = React.useState('watched');
            const [watchedMovies, setWatchedMovies] = React.useState([]);
            const [watchlist, setWatchlist] = React.useState([]);
            const [loading, setLoading] = React.useState(true);
            const [error, setError] = React.useState(null);

            React.useEffect(() => {
                if (!userId || !db) { setLoading(false); return; }
                setLoading(true);
                const unsubWatched = firestore.onSnapshot(firestore.collection(db, `users/${userId}/watched`), (snapshot) => {
                    setWatchedMovies(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });
                const unsubWatchlist = firestore.onSnapshot(firestore.collection(db, `users/${userId}/watchlist`), (snapshot) => {
                    setWatchlist(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });
                setLoading(false);
                return () => { unsubWatched(); unsubWatchlist(); };
            }, [userId, db]);
            
            const handleAddToWatchlist = async (movie) => {
                if (!userId || !db) return;
                if (watchlist.some(m => m.tmdb_id === movie.id)) { alert(`${movie.title} is already on your watchlist.`); return; }
                await firestore.addDoc(firestore.collection(db, `users/${userId}/watchlist`), {
                    tmdb_id: movie.id, title: movie.title, poster_path: movie.poster_path, release_date: movie.release_date, overview: movie.overview, added_at: firestore.Timestamp.now()
                });
            };

            const handleMoveToWatched = async (movieFromWatchlist) => {
                if (!userId || !db) return;
                const watchDateStr = prompt("When did you watch this? (YYYY-MM-DD)", new Date().toISOString().split('T')[0]);
                if (!watchDateStr || !/^\d{4}-\d{2}-\d{2}$/.test(watchDateStr)) { alert("Invalid date format. Please use YYYY-MM-DD."); return; }
                const watchDate = new Date(watchDateStr);
                const batch = firestore.writeBatch(db);
                batch.set(firestore.doc(firestore.collection(db, `users/${userId}/watched`)), {
                    tmdb_id: movieFromWatchlist.tmdb_id, title: movieFromWatchlist.title, poster_path: movieFromWatchlist.poster_path, release_date: movieFromWatchlist.release_date, overview: movieFromWatchlist.overview, watchedDate: firestore.Timestamp.fromDate(watchDate),
                });
                batch.delete(firestore.doc(db, `users/${userId}/watchlist`, movieFromWatchlist.id));
                await batch.commit();
            };

            const handleImportCsv = async (file) => {
                if (!file || !userId || !db) return;
                const reader = new FileReader();
                reader.onload = async (event) => {
                    const parsed = Papa.parse(event.target.result, { header: true, skipEmptyLines: true });
                    if (!parsed.data.length || !parsed.data[0].tmdb_id || !parsed.data[0].watchedDate) { setError("Invalid CSV. Required headers: 'tmdb_id', 'title', 'watchedDate' (YYYY-MM-DD)."); return; }
                    const batch = firestore.writeBatch(db);
                    parsed.data.forEach(row => {
                        if (row.tmdb_id && row.title && row.watchedDate) {
                            batch.set(firestore.doc(firestore.collection(db, `users/${userId}/watched`)), {
                                tmdb_id: parseInt(row.tmdb_id, 10), title: row.title, watchedDate: firestore.Timestamp.fromDate(new Date(row.watchedDate)), poster_path: row.poster_path || null, release_date: row.release_date || null, overview: row.overview || '',
                            });
                        }
                    });
                    await batch.commit();
                    alert(`${parsed.data.length} movies imported successfully!`);
                };
                reader.readAsText(file);
            };

            const WatchedTab = () => {
                const octoberMovies = watchedMovies.filter(m => m.watchedDate.toDate().getMonth() === 9);
                const progress = Math.min((octoberMovies.length / 31) * 100, 100);
                const groupedByDay = octoberMovies.reduce((acc, movie) => {
                    const dateStr = movie.watchedDate.toDate().toISOString().split('T')[0];
                    if (!acc[dateStr]) acc[dateStr] = [];
                    acc[dateStr].push(movie);
                    return acc;
                }, {});
                const sortedDays = Object.keys(groupedByDay).sort((a, b) => new Date(b) - new Date(a));
                return (
                    <div>
                        <div className="bg-zinc-800 p-4 rounded-lg mb-6 shadow-md">
                            <h2 className="text-xl font-bold text-white mb-2">October Progress</h2>
                            <p className="text-zinc-300 mb-4">{octoberMovies.length} of 31 movies watched</p>
                            <div className="w-full bg-zinc-700 rounded-full h-4"><div className="bg-red-600 h-4 rounded-full" style={{ width: `${progress}%` }}></div></div>
                        </div>
                        {sortedDays.map(date => (
                            <div key={date} className="mb-8">
                                <h3 className="text-2xl font-semibold text-red-500 mb-4 border-b-2 border-zinc-700 pb-2">
                                Watched on: {new Date(date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC' })}
                                </h3>
                                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                                    {groupedByDay[date].map(movie => <MovieCard key={movie.id} movie={movie} />)}
                                </div>
                            </div>
                        ))}
                    </div>
                );
            };

            const WatchlistTab = () => {
                const [searchTerm, setSearchTerm] = React.useState('');
                const [searchResults, setSearchResults] = React.useState([]);
                const [isSearching, setIsSearching] = React.useState(false);
                const handleSearch = async (e) => {
                    e.preventDefault();
                    if (!searchTerm) return;
                    setIsSearching(true);
                    try {
                        const response = await fetch(`/.netlify/functions/tmdb?endpoint=${encodeURIComponent(`search/movie?query=${searchTerm}`)}`);
                        if (!response.ok) throw new Error('Search request failed');
                        const data = await response.json();
                        if (data.error) throw new Error(data.error);
                        setSearchResults(data.results || []);
                    } catch (err) { console.error("Search Error:", err); setError(`Could not search: ${err.message}`); } 
                    finally { setIsSearching(false); }
                };
                return (
                    <div>
                        <form onSubmit={handleSearch} className="mb-8 flex">
                            <input type="text" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} placeholder="Search for a horror movie..." className="flex-grow bg-zinc-700 text-white p-3 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-red-500"/>
                            <button type="submit" className="bg-red-600 hover:bg-red-700 text-white p-3 rounded-r-lg" disabled={isSearching}>{isSearching ? '...' : <SearchIcon />}</button>
                        </form>
                        {searchResults.length > 0 && (<div className="mb-8"><h3 className="text-2xl font-semibold text-red-500 mb-4">Search Results</h3><div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">{searchResults.map(movie => (<MovieCard key={movie.id} movie={movie} onAction={handleAddToWatchlist} actionText="Add to Watchlist" actionIcon={<ListIcon/>}/>))}</div></div>)}
                        <h3 className="text-2xl font-semibold text-red-500 mb-4 mt-8 border-t-2 border-zinc-700 pt-4">My Watchlist</h3>
                        <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">{watchlist.map(movie => (<MovieCard key={movie.id} movie={movie} onAction={handleMoveToWatched} actionText="I Watched This!" actionIcon={<FilmIcon />}/>))}</div>
                    </div>
                );
            };
            
            const MetricsTab = () => {
                const watchCounts = watchedMovies.reduce((acc, movie) => { acc[movie.tmdb_id] = (acc[movie.tmdb_id] || 0) + 1; return acc; }, {});
                const moviesWithCounts = Object.entries(watchCounts).map(([tmdb_id, count]) => ({ ...watchedMovies.find(m => m.tmdb_id == tmdb_id), count })).sort((a, b) => b.count - a.count);
                return (
                    <div>
                        <h2 className="text-2xl font-semibold text-red-500 mb-4">All-Time Watch Metrics</h2>
                        <div className="bg-zinc-800 rounded-lg shadow-md overflow-hidden"><table className="min-w-full"><thead className="bg-zinc-700"><tr><th className="text-left py-3 px-4 font-semibold text-white">Movie Title</th><th className="text-left py-3 px-4 font-semibold text-white">Release Year</th><th className="text-left py-3 px-4 font-semibold text-white">Total Watches</th></tr></thead><tbody className="text-zinc-300">{moviesWithCounts.map((movie, index) => (<tr key={movie.tmdb_id} className={`border-t border-zinc-700 ${index % 2 === 0 ? 'bg-zinc-800' : 'bg-zinc-900/50'}`}><td className="py-3 px-4">{movie.title}</td><td className="py-3 px-4">{movie.release_date ? movie.release_date.split('-')[0] : 'N/A'}</td><td className="py-3 px-4 text-center font-bold text-red-500">{movie.count}</td></tr>))}</tbody></table></div>
                    </div>
                );
            };

            const ImportTab = () => {
                const [file, setFile] = React.useState(null);
                return (
                    <div className="bg-zinc-800 p-6 rounded-lg shadow-md">
                        <h2 className="text-xl font-bold text-white mb-4">Import Previous Years</h2>
                        <p className="text-zinc-400 mb-4">Upload a CSV file from a Google Sheet. Required columns: <strong>tmdb_id, title, watchedDate (YYYY-MM-DD)</strong>. Optional: poster_path, release_date, overview.</p>
                        <div className="flex items-center space-x-4">
                            <label className="w-full flex items-center px-4 py-2 bg-zinc-700 text-white rounded-lg shadow-lg tracking-wide uppercase border border-blue cursor-pointer hover:bg-red-700 hover:text-white">
                                <UploadIcon /><span className="ml-2 text-base leading-normal">{file ? file.name : "Select a CSV file"}</span>
                                <input type='file' accept=".csv" className="hidden" onChange={(e) => setFile(e.target.files[0])}/>
                            </label>
                            <button onClick={() => file && handleImportCsv(file)} disabled={!file} className="bg-red-600 text-white font-bold py-2 px-6 rounded-lg disabled:bg-zinc-500 disabled:cursor-not-allowed hover:bg-red-700 transition-colors">Import</button>
                        </div>
                    </div>
                )
            }

            if (!userId || !db) return <div className="text-center text-zinc-400 p-8">Please log in to use the Horror Movie Tracker.</div>;
            if (loading) return <div className="text-center text-zinc-300 p-8">Loading movie history...</div>;
            if (error) return <div className="bg-red-900 text-white p-4 rounded-lg text-center">{error}</div>;

            return (
                <div className="bg-black text-white font-sans w-full -m-4 md:-m-8">
                    <header className="bg-zinc-900 shadow-lg p-4"><div className="container mx-auto"><h1 className="text-3xl font-bold text-red-600 tracking-wider">31 Nights of Horror</h1></div></header>
                    <nav className="bg-zinc-800"><div className="container mx-auto flex justify-center items-center space-x-2 md:space-x-4 p-2 text-sm md:text-base">
                        <button onClick={() => setActiveTab('watched')} className={`flex items-center px-4 py-2 rounded-lg transition-colors ${activeTab === 'watched' ? 'bg-red-600 text-white' : 'text-zinc-300 hover:bg-zinc-700'}`}><FilmIcon /> Watched</button>
                        <button onClick={() => setActiveTab('watchlist')} className={`flex items-center px-4 py-2 rounded-lg transition-colors ${activeTab === 'watchlist' ? 'bg-red-600 text-white' : 'text-zinc-300 hover:bg-zinc-700'}`}><ListIcon /> Watchlist</button>
                        <button onClick={() => setActiveTab('metrics')} className={`flex items-center px-4 py-2 rounded-lg transition-colors ${activeTab === 'metrics' ? 'bg-red-600 text-white' : 'text-zinc-300 hover:bg-zinc-700'}`}><ChartIcon /> Metrics</button>
                        <button onClick={() => setActiveTab('import')} className={`flex items-center px-4 py-2 rounded-lg transition-colors ${activeTab === 'import' ? 'bg-red-600 text-white' : 'text-zinc-300 hover:bg-zinc-700'}`}><UploadIcon/> Import</button>
                    </div></nav>
                    <main className="container mx-auto p-4 md:p-6">
                        {activeTab === 'watched' && <WatchedTab />}
                        {activeTab === 'watchlist' && <WatchlistTab />}
                        {activeTab === 'metrics' && <MetricsTab />}
                        {activeTab === 'import' && <ImportTab />}
                    </main>
                </div>
            );
        }

        // This function will be called from your main script to render the app
        function renderHorrorTracker(db, userId, firestore) {
            const container = document.getElementById('horror-tracker-root');
            const root = ReactDOM.createRoot(container);
            root.render(<HorrorTracker db={db} userId={userId} firestore={firestore} />);
        }
    </script>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, deleteDoc, collection, addDoc, writeBatch, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        async function initializeAppWithConfig() {
            // ... existing initializeAppWithConfig function ...
        }

        function runApp(firebaseConfig) {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            const googleProvider = new GoogleAuthProvider();
            let userDocRef = null;
            let unsubscribeUserDoc = null;
            let isDataLoaded = false;
            let userId = null;

            // ... existing state object and helper functions ...
            
            // MODIFIED: Pass all firestore functions to the React component
            const firestoreFunctions = {
                collection, addDoc, writeBatch, Timestamp, doc, onSnapshot, setDoc, deleteDoc
            };

            onAuthStateChanged(auth, (user) => {
                if (unsubscribeUserDoc) unsubscribeUserDoc();
                isDataLoaded = false;

                if (user) {
                    userId = user.uid;
                    userDocRef = doc(db, "users", userId);
                    loginScreen.classList.add('hidden');
                    mainApp.classList.remove('hidden');
                    suggestionAvatarBtn.classList.remove('hidden');

                    // ADDED: Render the React component once the user is logged in
                    renderHorrorTracker(db, userId, firestoreFunctions);
                    
                    unsubscribeUserDoc = onSnapshot(userDocRef, (docSnap) => {
                        // ... existing onSnapshot logic ...
                    });
                } else {
                    // ... existing sign-out logic ...
                }
            });

            // ... other functions (handleGoogleSignIn, etc.) ...
            
            async function switchTab(tabName) {
                state.activeTab = tabName;
                document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
                const tabEl = $(tabName);
                
                // MODIFIED: Use horror-tracker ID for the new tab
                if (tabName === 'horror-tracker') {
                    $('horror-tracker').classList.remove('hidden');
                } else if (tabEl) {
                    tabEl.classList.remove('hidden');
                }
                
                tabs.forEach(tab => {
                    const isCurrentTab = tab.dataset.tab === tabName;
                    tab.classList.toggle('text-zinc-400', isCurrentTab);
                    tab.classList.toggle('border-zinc-400', isCurrentTab);
                    tab.classList.toggle('font-medium', isCurrentTab);
                    tab.classList.toggle('text-zinc-500', !isCurrentTab);
                    tab.classList.toggle('border-transparent', !isCurrentTab);
                });

                if (tabName === 'dashboard') await fetchDashboardData();
                if (tabName === 'favorites') await renderFavorites();
                if (tabName === 'schedule') { await fetchScheduleData(); renderSchedule(); }
            }

            // ... all other existing functions in runApp ...

            // Must re-grab tabs NodeList after adding new one to HTML
            const tabs = document.querySelectorAll('.tab-button');
            tabs.forEach(tab => tab.addEventListener('click', () => switchTab(tab.dataset.tab)));
        
            // ... existing initEventListeners, but tabs are handled above now
        }

        document.addEventListener('DOMContentLoaded', initializeAppWithConfig);
    </script>
</body>
</html>

