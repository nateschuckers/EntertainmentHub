<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entertainment Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@700&family=Creepster&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        zinc: {
                            50:"#fafafa",100:"#f4f4f5",200:"#e4e4e7",300:"#d4d4d8",400:"#a1a1aa",500:"#71717a",600:"#52525b",700:"#3f3f46",800:"#27272a",900:"#18181b",950:"#09090b"
                        }
                    },
                    fontFamily: {
                        'script': ['Caveat', 'cursive'],
                        'horror': ['Creepster', 'cursive']
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex; justify-content: center; align-items: center; z-index: 50;
        }
        .modal-content { max-height: 90vh; overflow-y: auto; }
        .calendar-day.has-event { background-color: #3f3f46; border-radius: 50%; color: white; }
        .scrolling-wrapper { -webkit-overflow-scrolling: touch; }
        .scrolling-wrapper::-webkit-scrollbar { display: none; }
        .config-error-screen {
            display: flex; align-items: center; justify-content: center;
            position: fixed; inset: 0; background-color: #09090b; z-index: 100;
        }
        .config-error-box {
            background-color: #18181b; color: white; padding: 2rem; border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            text-align: center; max-width: 500px;
        }
        .config-error-box h1 { font-size: 1.5rem; font-weight: bold; color: #ef4444; margin-bottom: 1rem; }
        .config-error-box p { color: #d4d4d8; margin-bottom: 1.5rem; font-family: monospace; font-size: 0.875rem; text-align: left; background-color: #3f3f46; padding: 1rem; border-radius: 0.25rem;}
        
        .favorite-card-manage-overlay {
            position: absolute;
            top: 0; right: 0; bottom: 0; left: 0;
            background-color: rgba(0,0,0,0.5);
            cursor: pointer;
            border-radius: 0.5rem; /* Match card rounding */
            transition: all 0.2s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .favorite-card-manage-checkbox {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0; /* Hide the actual checkbox */
            cursor: pointer;
        }
        .x-mark-svg {
            display: none; /* Hidden by default */
            width: 4rem;
            height: 4rem;
            color: white;
        }
        .favorite-card.selected .favorite-card-manage-overlay {
            background-color: rgba(39, 39, 42, 0.7);
        }
        .favorite-card.selected .x-mark-svg {
            display: block;
        }
        .favorite-card.selected img {
            filter: grayscale(80%) brightness(50%);
        }

        /* --- Horror Theme --- */
        @keyframes flicker {
            0%, 100% { text-shadow: 0 0 2px #ef4444, 0 0 5px #ef4444; opacity: 1; }
            50% { text-shadow: 0 0 2px #ef4444; opacity: 0.8; }
        }

        .theme-horror .font-script {
            font-family: 'Creepster', cursive;
            animation: flicker 2.5s infinite alternate;
        }
        .theme-horror .tab-button.border-zinc-400 {
            border-color: #ef4444; /* red-500 */
            color: #f87171; /* red-400 */
        }
        .theme-horror .bg-zinc-900 { background-color: #000; }
        .theme-horror .bg-zinc-800 { background-color: #111; }
        .theme-horror .bg-zinc-700 { background-color: #222; }
        .theme-horror .hover\:bg-zinc-600:hover { background-color: #333; }
        .theme-horror .border-zinc-700 { border-color: #444; }
        .theme-horror .text-zinc-400 { color: #d4d4d8; }
        .theme-horror .upcoming-filter-btn.bg-zinc-900 { background-color: #b91c1c; }
        .theme-horror #danger-zone {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path d="M50 0 C60 10, 70 15, 60 25 C50 35, 40 40, 50 50 C60 60, 70 65, 60 75 C50 85, 40 90, 50 100" fill="%23991b1b" opacity="0.1" transform="rotate(20 50 50)"/><path d="M20 10 C30 20, 40 25, 30 35 C20 45, 10 50, 20 60 C30 70, 40 75, 30 85" fill="%237f1d1d" opacity="0.1" transform="rotate(-15 50 50)"/></svg>');
            background-repeat: no-repeat;
            background-position: right -20px bottom -30px;
            background-size: 150px;
        }
    </style>
</head>
<body class="bg-zinc-900 text-zinc-200">
    <div id="configErrorScreen" class="config-error-screen hidden"></div>

    <!-- Login Screen -->
    <div id="loginScreen" class="fixed inset-0 bg-zinc-900 flex flex-col justify-center items-center z-50">
        <div class="text-center p-4">
            <h1 class="text-5xl sm:text-6xl font-script text-zinc-400 mb-4">Entertainment Hub</h1>
            <p class="text-zinc-400 mb-8">Please sign in to continue</p>
            <button id="signInWithGoogleButton" class="bg-zinc-700 hover:bg-zinc-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300 flex items-center justify-center mx-auto">
                <svg class="w-6 h-6 mr-3" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"></path><path fill="#FF3D00" d="M6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C16.318 4 9.656 8.337 6.306 14.691z"></path><path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238C29.211 35.091 26.715 36 24 36c-5.222 0-9.618-3.319-11.283-7.946l-6.522 5.025C9.505 39.556 16.227 44 24 44z"></path><path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.231 4.166-4.087 5.571l6.19 5.238C42.012 35.238 44 30.025 44 24c0-1.341-.138-2.65-.389-3.917z"></path></svg>
                Sign in with Google
            </button>
        </div>
    </div>

    <div id="app" class="container mx-auto p-4 md:p-8 hidden">
        
        <header class="text-center mb-8">
            <h1 class="text-5xl sm:text-6xl font-script text-zinc-400">Entertainment Hub</h1>
            <p class="text-zinc-400 mt-2">Find where to watch your favorite shows and movies.</p>
        </header>

        <div class="mb-8 max-w-2xl mx-auto">
            <div id="searchWrapper" class="relative">
                <input type="text" id="searchInput" class="w-full bg-zinc-800 border-2 border-zinc-700 rounded-full py-3 px-6 text-white placeholder-zinc-500 focus:outline-none focus:border-zinc-500 transition duration-300" placeholder="Search for a movie or show..." autocomplete="off">
                <button id="searchButton" class="absolute right-0 top-0 mt-2 mr-2 bg-zinc-700 hover:bg-zinc-600 rounded-full p-2 focus:outline-none transition duration-300">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </button>
                <div id="liveSearchResults" class="hidden absolute z-20 w-full mt-2 bg-zinc-800 border border-zinc-700 rounded-lg shadow-lg"></div>
            </div>
        </div>

        <div class="mb-8">
            <div class="flex justify-center flex-wrap border-b border-zinc-700">
                <button data-tab="dashboard" class="tab-button flex items-center justify-center gap-2 py-3 px-4 md:px-4 border-b-2 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3h7v7H3zM14 3h7v7h-7zM14 14h7v7h-7zM3 14h7v7H3z"/></svg>
                    <span class="hidden md:inline">Dashboard</span>
                </button>
                <button data-tab="favorites" class="tab-button flex items-center justify-center gap-2 py-3 px-4 md:px-4 border-b-2 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
                    <span class="hidden md:inline">Favorites</span>
                </button>
                <button data-tab="schedule" class="tab-button flex items-center justify-center gap-2 py-3 px-4 md:px-4 border-b-2 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                    <span class="hidden md:inline">Schedule</span>
                </button>
                <button data-tab="settings" class="tab-button flex items-center justify-center gap-2 py-3 px-4 md:px-4 border-b-2 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
                    <span class="hidden md:inline">Settings</span>
                </button>
            </div>
        </div>

        <main id="content-area">
            <div id="dashboard" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 bg-zinc-800 p-6 rounded-lg">
                        <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4">
                            <h2 class="text-2xl font-bold w-full sm:w-auto mb-4 sm:mb-0">Upcoming for <span id="dashboardUserName">You</span></h2>
                            <div class="flex space-x-1 bg-zinc-700 p-1 rounded-lg">
                                <button data-filter="today" class="upcoming-filter-btn bg-zinc-900 text-white px-3 py-1 rounded-md text-sm font-medium">Today</button>
                                <button data-filter="week" class="upcoming-filter-btn text-zinc-300 px-3 py-1 rounded-md text-sm font-medium">7 Day</button>
                                <button data-filter="month" class="upcoming-filter-btn text-zinc-300 px-3 py-1 rounded-md text-sm font-medium">30 Day</button>
                            </div>
                        </div>
                        <div id="upcomingContainer" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2"></div>
                    </div>
                    <div class="lg:col-span-1 space-y-8">
                        <div>
                             <h2 class="text-2xl font-bold mb-4">Trending Now</h2>
                            <div class="relative">
                                <div id="trendingContainer" class="flex overflow-x-auto space-x-4 pb-4 scrolling-wrapper bg-zinc-800 p-4 rounded-lg"></div>
                                <button id="scrollLeftBtn" class="absolute left-0 top-1/2 -translate-y-1/2 bg-zinc-900 bg-opacity-50 hover:bg-opacity-75 text-white p-2 rounded-full z-10">&lt;</button>
                                <button id="scrollRightBtn" class="absolute right-0 top-1/2 -translate-y-1/2 bg-zinc-900 bg-opacity-50 hover:bg-opacity-75 text-white p-2 rounded-full z-10">&gt;</button>
                            </div>
                        </div>
                         <div>
                             <h2 class="text-2xl font-bold mb-4">Upcoming Movies</h2>
                            <div class="relative">
                                <div id="upcomingMoviesContainer" class="flex overflow-x-auto space-x-4 pb-4 scrolling-wrapper bg-zinc-800 p-4 rounded-lg"></div>
                                <button id="scrollUpcomingLeftBtn" class="absolute left-0 top-1/2 -translate-y-1/2 bg-zinc-900 bg-opacity-50 hover:bg-opacity-75 text-white p-2 rounded-full z-10">&lt;</button>
                                <button id="scrollUpcomingRightBtn" class="absolute right-0 top-1/2 -translate-y-1/2 bg-zinc-900 bg-opacity-50 hover:bg-opacity-75 text-white p-2 rounded-full z-10">&gt;</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="search-results" class="tab-content hidden">
                 <h2 class="text-2xl font-bold mb-4 text-center">Search Results</h2>
                <p id="searchResultsMessage" class="text-center text-zinc-500">Search for something to see results.</p>
                <div id="searchResultsContainer" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6"></div>
            </div>

            <div id="favorites" class="tab-content hidden">
                <div class="max-w-4xl mx-auto">
                    <div id="favorites-header" class="flex flex-col sm:flex-row justify-between sm:items-center mb-4">
                        <h2 class="text-2xl font-bold w-full sm:w-auto mb-4 sm:mb-0">My Favorites</h2>
                        <div id="favorites-view-controls" class="flex items-center space-x-4">
                            <div class="flex space-x-1 bg-zinc-700 p-1 rounded-lg">
                                <button class="fav-view-btn bg-zinc-900 text-white px-3 py-1 rounded-md text-sm font-medium" data-view="grid">Grid</button>
                                <button class="fav-view-btn text-zinc-300 px-3 py-1 rounded-md text-sm font-medium" data-view="list">List</button>
                            </div>
                             <button id="manageFavoritesBtn" class="bg-zinc-600 hover:bg-zinc-500 text-white font-bold py-1 px-3 rounded text-sm">Manage</button>
                        </div>
                    </div>
                     <div id="favorites-manage-controls" class="hidden flex justify-between items-center mb-4 bg-zinc-700 p-2 rounded-lg">
                        <span id="favoritesSelectedCount" class="text-sm font-medium">0 selected</span>
                        <div class="flex space-x-2">
                             <button id="deleteSelectedFavoritesBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded text-sm">Delete Selected</button>
                             <button id="deleteAllFavoritesBtn" class="bg-red-800 hover:bg-red-700 text-white font-bold py-1 px-3 rounded text-sm">Remove All</button>
                             <button id="cancelManageFavoritesBtn" class="bg-zinc-500 hover:bg-zinc-400 text-white font-bold py-1 px-3 rounded text-sm">Done</button>
                        </div>
                    </div>
                    <p id="favoritesMessage" class="text-center text-zinc-500">Your favorite shows and movies will appear here.</p>
                    <div id="favoritesContainer" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>
                    <div id="favoritesListContainer" class="hidden space-y-3"></div>
                </div>
            </div>

            <div id="schedule" class="tab-content hidden">
                <div class="max-w-4xl mx-auto bg-zinc-800 p-6 rounded-lg shadow-lg">
                    <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4">
                        <h2 class="text-2xl font-bold w-full sm:w-auto mb-4 sm:mb-0">Upcoming Episodes</h2>
                        <div class="flex space-x-1 bg-zinc-700 p-1 rounded-lg">
                            <button class="schedule-view-btn text-zinc-300 px-3 py-1 rounded-md text-sm font-medium" data-view="calendar">Calendar</button>
                            <button class="schedule-view-btn bg-zinc-900 text-white px-3 py-1 rounded-md text-sm font-medium" data-view="agenda">Agenda</button>
                        </div>
                    </div>
                    <div id="scheduleContent" class="max-h-[60vh] overflow-y-auto pr-2"></div>
                     <p id="scheduleMessage" class="text-center text-zinc-500 mt-4 hidden"></p>
                </div>
            </div>

            <div id="settings" class="tab-content hidden">
                <div class="max-w-4xl mx-auto bg-zinc-800 p-6 rounded-lg shadow-lg space-y-8">
                    <div id="accountSection"></div>
                    <div>
                        <h2 class="text-2xl font-bold mb-4">Your Name</h2>
                        <p class="text-zinc-400 mb-4">Personalize the dashboard greeting.</p>
                        <div class="flex flex-col sm:flex-row sm:space-x-2">
                            <input type="text" id="userNameInput" class="w-full mb-2 sm:mb-0 bg-zinc-700 border border-zinc-600 rounded-md py-2 px-4 text-white placeholder-zinc-500 focus:outline-none focus:border-zinc-500" placeholder="Enter your name">
                            <button id="saveUserNameButton" class="bg-zinc-700 hover:bg-zinc-600 text-white font-bold py-2 px-4 rounded transition duration-300 whitespace-nowrap">Save Name</button>
                        </div>
                         <p id="userNameMessage" class="text-sm text-green-400 mt-2 hidden"></p>
                    </div>
                     <div>
                        <h2 class="text-2xl font-bold mb-4">Theme</h2>
                        <div id="themeSelector" class="flex space-x-2">
                            <button data-theme="default" class="theme-btn bg-zinc-700 hover:bg-zinc-600 text-white font-bold py-2 px-4 rounded transition duration-300">Default</button>
                            <button data-theme="horror" class="theme-btn bg-zinc-700 hover:bg-zinc-600 text-white font-bold py-2 px-4 rounded transition duration-300">Horror</button>
                        </div>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold mb-4">Manage Your Streaming Services</h2>
                        <p class="text-zinc-400 mb-6">Select the services you subscribe to for a personalized experience.</p>
                        <div id="subscriptionList" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"></div>
                    </div>
                    <div id="danger-zone" class="border-t border-red-900/50 pt-6">
                        <h2 class="text-2xl font-bold mb-4 text-red-400">Danger Zone</h2>
                        <div class="bg-red-900/20 p-4 rounded-lg flex flex-col sm:flex-row items-center justify-between">
                            <div>
                                <h3 class="font-bold">Delete Account & Data</h3>
                                <p class="text-red-300 text-sm mt-1">Permanently delete your account and all associated data.</p>
                            </div>
                             <button id="deleteAccountBtn" class="mt-4 sm:mt-0 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition duration-300 whitespace-nowrap">Delete Account</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <div id="loadingSpinner" class="hidden fixed inset-0 bg-zinc-900 bg-opacity-50 flex justify-center items-center z-50">
             <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-zinc-500"></div>
        </div>
    </div>

    <div id="detailsModal" class="modal-backdrop hidden">
        <div id="modalContent" class="modal-content bg-zinc-800 text-white rounded-lg shadow-xl w-11/12 md:w-3/4 lg:w-1/2 p-6 relative"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        async function initializeAppWithConfig() {
            function renderConfigError(message) {
                const errorScreen = document.getElementById('configErrorScreen');
                errorScreen.innerHTML = `<div class="config-error-box"><h1>Application Error</h1><p>${message}</p></div>`;
                errorScreen.classList.remove('hidden');
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('app').classList.add('hidden');
            }

            try {
                const response = await fetch('/.netlify/functions/get-firebase-config');
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Server returned status ${response.status}. Response: ${errorText.substring(0, 200)}...`);
                }
                const firebaseConfig = await response.json();
                
                if (!firebaseConfig.apiKey) {
                     throw new Error("Received config is missing critical keys. Check Netlify environment variables.");
                }
                runApp(firebaseConfig);

            } catch (error) {
                let errorMessage = error.message;
                if (error instanceof SyntaxError) {
                    errorMessage = "The server returned an invalid response (likely HTML instead of JSON). This is a routing issue. Please ensure your netlify.toml redirect rule is correct.";
                }
                renderConfigError(errorMessage);
            }
        }

        function runApp(firebaseConfig) {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            const googleProvider = new GoogleAuthProvider();
            let userDocRef = null;
            let unsubscribeUserDoc = null;
            let isDataLoaded = false;
            let userId = null;

            const state = {
                userName: null,
                theme: 'default',
                activeTab: 'dashboard',
                favoritesView: 'grid',
                scheduleView: 'agenda',
                dashboardScheduleFilter: 'today',
                isManagingFavorites: false,
                currentDate: new Date(),
                subscriptions: [],
                favorites: [],
                scheduledEpisodes: [],
                streamingServices: [
                    { id: 528, name: 'AMC+', logo: 'l4g1BT502p1H42a3j1s2lG9nK.jpg' },
                    { id: 9, name: 'Amazon Prime', logo: '68MNdJkIZ1hqhGPY3e4L2MSuD1I.jpg' },
                    { id: 2, name: 'Apple TV+', logo: '3oTfWy5TAmY5822b53eKwL1xS2z.jpg' },
                    { id: 26, name: 'Criterion Channel', logo: 'hFCiMC5st22wV3weHl15qj7N0v1.jpg' },
                    { id: 337, name: 'Disney+', logo: '7rwgEs15tFwyR9NPQ5vpzxTj1Ae.jpg' },
                    { id: 257, name: 'FuboTV', logo: 'fVjXoJkU1H_2p7iN1b1g2p1fOUl.jpg' },
                    { id: 15, name: 'Hulu', logo: 'uJ2w33J32O2h05Iu1CjC7mGn4T.jpg' },
                    { id: 1899, name: 'Max', logo: '2a0aJqjuiD5ytdcZz2uISeidU8C.jpg' },
                    { id: 8, name: 'Netflix', logo: 'ar4pMQERJSYppG3Qfo9ltM4S2sM.jpg' },
                    { id: 531, name: 'Paramount+', logo: 'zBv2r2k2sV3E9s08i0lBq4vIZy.jpg' },
                    { id: 387, name: 'Peacock', logo: 'pZGE52Lz17c38gNT7P7y0B0iC4.jpg' },
                    { id: 37, name: 'Showtime', logo: 'oF4enqrXXsFRU3aG2I32vpsbQv.jpg' },
                    { id: 43, name: 'Starz', logo: 'crFbxgG3JSddT2DAorfOqdfE5s9.jpg' }
                ]
            };
            
            const $ = (selector) => document.getElementById(selector);
            
            const loginScreen = $('loginScreen'), mainApp = $('app'), accountSection = $('accountSection'), modal = $('detailsModal'), modalContent = $('modalContent'),
            searchInput = $('searchInput'), searchButton = $('searchButton'), liveSearchResults = $('liveSearchResults'), searchResultsContainer = $('searchResultsContainer'), 
            searchResultsMessage = $('searchResultsMessage'), favoritesContainer = $('favoritesContainer'), favoritesListContainer = $('favoritesListContainer'), favoritesMessage = $('favoritesMessage'),
            scheduleContent = $('scheduleContent'), scheduleMessage = $('scheduleMessage'), subscriptionList = $('subscriptionList'), userNameInput = $('userNameInput'), 
            saveUserNameButton = $('saveUserNameButton'), userNameMessage = $('userNameMessage'), dashboardUserName = $('dashboardUserName'), upcomingContainer = $('upcomingContainer'),
            trendingContainer = $('trendingContainer'), upcomingMoviesContainer = $('upcomingMoviesContainer'), scrollLeftBtn = $('scrollLeftBtn'), scrollRightBtn = $('scrollRightBtn'),
            scrollUpcomingLeftBtn = $('scrollUpcomingLeftBtn'), scrollUpcomingRightBtn = $('scrollUpcomingRightBtn'),
            favoritesViewControls = $('favorites-view-controls'), favoritesManageControls = $('favorites-manage-controls');
            
            const tabs = document.querySelectorAll('.tab-button');
            const favViewBtns = document.querySelectorAll('.fav-view-btn');
            const scheduleViewBtns = document.querySelectorAll('.schedule-view-btn');
            const upcomingFilterBtns = document.querySelectorAll('.upcoming-filter-btn');
            const themeBtns = document.querySelectorAll('.theme-btn');

            onAuthStateChanged(auth, (user) => {
                if (unsubscribeUserDoc) unsubscribeUserDoc();
                isDataLoaded = false;

                if (user) {
                    userId = user.uid;
                    userDocRef = doc(db, "users", userId);
                    loginScreen.classList.add('hidden');
                    mainApp.classList.remove('hidden');
                    
                    unsubscribeUserDoc = onSnapshot(userDocRef, (docSnap) => {
                        const wasAlreadyLoaded = isDataLoaded;
                        if (docSnap.exists()) {
                            loadDataFromFirestore(docSnap.data());
                        } else {
                            if(isDataLoaded) return;
                            saveDataToFirestore();
                            return; 
                        }
                        
                        applyTheme(state.theme);

                        if (!wasAlreadyLoaded) {
                           isDataLoaded = true;
                           initAppUI(); 
                        } else {
                           refreshCurrentView();
                        }
                    });
                } else {
                    userId = null;
                    userDocRef = null;
                    applyTheme('default'); // Reset to default on logout
                    loginScreen.classList.remove('hidden');
                    mainApp.classList.add('hidden');
                    state.favorites = [];
                    state.subscriptions = [];
                    state.userName = null;
                }
            });

            function handleGoogleSignIn() {
                signInWithPopup(auth, googleProvider).catch(console.error);
            }

            function updateAccountSection() {
                const user = auth.currentUser;
                if (user) {
                    accountSection.innerHTML = `<h2 class="text-2xl font-bold mb-4">Account</h2><p class="text-zinc-400 mb-4">Signed in as ${user.displayName || user.email}</p><button id="signOutButton" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition">Sign Out</button>`;
                    const signOutButton = $('signOutButton');
                    if(signOutButton) signOutButton.addEventListener('click', () => signOut(auth));
                    const deleteAccountBtn = $('deleteAccountBtn');
                    if(deleteAccountBtn) deleteAccountBtn.addEventListener('click', handleDeleteAccount);
                }
            }

            function handleDeleteAccount() {
                showConfirmationModal("Are you sure you want to delete your account and all data? This action cannot be undone.", async () => {
                    if (userDocRef) {
                        try {
                            await deleteDoc(userDocRef);
                            await signOut(auth);
                        } catch (e) {
                            console.error("Error deleting document: ", e);
                        }
                    }
                });
            }

            function showConfirmationModal(message, onConfirm) {
                const confirmModalContent = `
                    <div class="text-center p-6">
                        <h2 class="text-2xl font-bold mb-4 text-red-400">Are you sure?</h2>
                        <p class="text-zinc-300 mb-6">${message}</p>
                        <div class="flex justify-center space-x-4">
                            <button id="confirmCancel" class="bg-zinc-600 hover:bg-zinc-500 text-white font-bold py-2 px-6 rounded-lg transition">Cancel</button>
                            <button id="confirmAction" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition">Confirm</button>
                        </div>
                    </div>`;
                modalContent.innerHTML = confirmModalContent;
                modal.classList.remove('hidden');
                
                $('confirmAction').addEventListener('click', () => {
                    onConfirm();
                    closeModal();
                });
                $('confirmCancel').addEventListener('click', closeModal);
            }
             
            async function saveDataToFirestore() {
                if (!userDocRef) return;
                const dataToSave = {
                    userName: state.userName,
                    subscriptions: state.subscriptions,
                    favorites: state.favorites,
                    theme: state.theme
                };
                try {
                    await setDoc(userDocRef, dataToSave, { merge: true });
                } catch (e) {
                    console.error("Error writing document: ", e);
                }
            }

            function loadDataFromFirestore(data) {
                state.userName = data.userName || null;
                state.subscriptions = data.subscriptions || [];
                state.favorites = data.favorites || [];
                state.theme = data.theme || 'default';
                if (userNameInput && state.userName) userNameInput.value = state.userName;
            }

            function applyTheme(theme) {
                document.body.classList.remove('theme-horror');
                if(theme === 'horror') {
                    document.body.classList.add('theme-horror');
                }
                themeBtns.forEach(btn => {
                    btn.classList.toggle('bg-zinc-900', btn.dataset.theme === theme);
                    btn.classList.toggle('bg-zinc-700', btn.dataset.theme !== theme);
                });
            }

            async function apiFetch(endpoint) {
                const url = `/.netlify/functions/tmdb?endpoint=${encodeURIComponent(endpoint)}`;
                const response = await fetch(url);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Network response was not ok');
                }
                return response.json();
            }
            
            function promptForLogin(feature = 'this feature') {
                 modalContent.innerHTML = `<div class="text-center p-4"><h2 class="text-2xl font-bold mb-4">Please Sign In</h2><p class="text-zinc-400 mb-6">To use ${feature}, you need to be signed in.</p><button id="modalSignInButton" class="bg-zinc-700 hover:bg-zinc-600 text-white font-bold py-3 px-6 rounded-lg transition">Sign in with Google</button><button id="modalCloseButton" class="mt-4 text-zinc-400 hover:text-white">Cancel</button></div>`;
                 modal.classList.remove('hidden');
                 $('modalSignInButton').addEventListener('click', () => { handleGoogleSignIn(); closeModal(); });
                 $('modalCloseButton').addEventListener('click', closeModal);
            }
            
            function toggleSubscription(serviceId) {
                if (!userId) { promptForLogin('managing subscriptions'); return; }
                const index = state.subscriptions.indexOf(serviceId);
                if (index > -1) state.subscriptions.splice(index, 1);
                else state.subscriptions.push(serviceId);
                saveDataToFirestore();
            }

            function toggleFavorite(mediaItem) {
                if (!userId) { promptForLogin('saving favorites'); return; }
                const index = state.favorites.findIndex(fav => fav.id === mediaItem.id);
                if (index > -1) {
                    state.favorites.splice(index, 1);
                } else {
                    state.favorites.push({
                        id: mediaItem.id,
                        name: mediaItem.name || null,
                        title: mediaItem.title || null,
                        poster_path: mediaItem.poster_path, 
                        first_air_date: mediaItem.first_air_date || null,
                        release_date: mediaItem.release_date || null, 
                        media_type: mediaItem.title ? 'movie' : 'tv',
                        manualTime: null
                    });
                }
                saveDataToFirestore();
                renderModal(mediaItem);
            }
            
            async function switchTab(tabName) {
                state.activeTab = tabName;
                document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
                const tabEl = $(tabName);
                if (tabEl) tabEl.classList.remove('hidden');
                
                tabs.forEach(tab => {
                    const isCurrentTab = tab.dataset.tab === tabName;
                    tab.classList.toggle('text-zinc-400', isCurrentTab);
                    tab.classList.toggle('border-zinc-400', isCurrentTab);
                    tab.classList.toggle('font-medium', isCurrentTab);
                    tab.classList.toggle('text-zinc-500', !isCurrentTab);
                    tab.classList.toggle('border-transparent', !isCurrentTab);
                });

                if (tabName === 'dashboard') await fetchDashboardData();
                if (tabName === 'favorites') await renderFavorites();
                if (tabName === 'schedule') { await fetchScheduleData(); renderSchedule(); }
            }

            function createMediaCard(item, isManageMode = false) {
                const cardWrapper = document.createElement('div');
                cardWrapper.className = 'relative favorite-card';

                const card = document.createElement('div');
                card.className = 'bg-zinc-800 rounded-lg overflow-hidden shadow-lg transform hover:scale-105 transition duration-300 h-full';
                card.dataset.id = item.id;
                card.dataset.type = item.media_type || (item.title ? 'movie' : 'tv');
                const title = item.title || item.name;
                const releaseDate = item.release_date || item.first_air_date;
                const year = releaseDate ? new Date(releaseDate).getFullYear() : 'N/A';
                const posterUrl = item.poster_path ? `https://image.tmdb.org/t/p/w500${item.poster_path}` : 'https://placehold.co/500x750/374151/FFFFFF?text=No+Image';
                card.innerHTML = `<img src="${posterUrl}" alt="${title}" class="w-full h-auto object-cover transition-all duration-300"><div class="p-4"><h3 class="font-bold text-md truncate">${title}</h3><p class="text-sm text-zinc-400">${year}</p></div>`;
                
                if (isManageMode) {
                    const overlay = document.createElement('div');
                    overlay.className = 'favorite-card-manage-overlay';
                    overlay.innerHTML = `
                        <svg class="x-mark-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                            <circle cx="26" cy="26" r="25" fill="rgba(239, 68, 68, 0.7)"/>
                            <path stroke="white" stroke-width="5" d="M16 16 36 36 M36 16 16 36" />
                        </svg>
                    `;
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'favorite-card-manage-checkbox w-full h-full absolute top-0 left-0';
                    checkbox.value = item.id;
                    overlay.appendChild(checkbox);
                    cardWrapper.appendChild(overlay);

                    cardWrapper.addEventListener('click', (e) => {
                        e.preventDefault();
                        checkbox.checked = !checkbox.checked;
                        cardWrapper.classList.toggle('selected');
                        updateSelectedCount();
                    });
                } else {
                     card.classList.add('cursor-pointer');
                     card.addEventListener('click', () => getMediaDetails(item.id, card.dataset.type));
                }

                cardWrapper.appendChild(card);
                return cardWrapper;
            }

            function renderSearchResults(mediaResults = []) {
                const validMedia = mediaResults.filter(item => item.media_type !== 'person' && item.poster_path);
                searchResultsContainer.innerHTML = '';
                searchResultsMessage.classList.add('hidden');
                if (validMedia.length === 0) {
                    searchResultsMessage.textContent = 'No results found.';
                    searchResultsMessage.classList.remove('hidden');
                    return;
                }
                validMedia.forEach(item => searchResultsContainer.appendChild(createMediaCard(item)));
            }
            
            function renderLiveSearchResults(results = []) {
                liveSearchResults.innerHTML = '';
                const validResults = results.filter(item => item.media_type !== 'person' && item.poster_path).slice(0, 5);
                if (validResults.length === 0) {
                    liveSearchResults.classList.add('hidden');
                    return;
                }
                validResults.forEach(item => {
                    const title = item.title || item.name;
                    const el = document.createElement('div');
                    el.className = 'flex items-center space-x-3 p-3 hover:bg-zinc-700 cursor-pointer';
                    el.innerHTML = `<img src="https://image.tmdb.org/t/p/w92${item.poster_path}" class="w-10 h-auto rounded-md"><span>${title}</span>`;
                    el.addEventListener('click', () => {
                        getMediaDetails(item.id, item.media_type);
                        liveSearchResults.classList.add('hidden');
                        searchInput.value = '';
                    });
                    liveSearchResults.appendChild(el);
                });
                liveSearchResults.classList.remove('hidden');
            }


            function renderSubscriptions() {
                subscriptionList.innerHTML = '';
                state.streamingServices.forEach(service => {
                    const isChecked = state.subscriptions.includes(service.id);
                    const logoUrl = `https://image.tmdb.org/t/p/w92/${service.logo}`;
                    const item = document.createElement('div');
                    item.className = `flex items-center space-x-3 p-3 rounded-lg cursor-pointer transition duration-300 ${isChecked ? 'bg-zinc-900' : 'bg-zinc-700 hover:bg-zinc-600'}`;
                    item.dataset.serviceId = service.id;
                    item.innerHTML = `<img src="${logoUrl}" alt="${service.name}" class="w-10 h-10 rounded-md object-cover" onerror="this.style.display='none'"><span class="font-medium text-sm">${service.name}</span>`;
                    item.addEventListener('click', () => toggleSubscription(service.id));
                    subscriptionList.appendChild(item);
                });
            }

            function renderModal(details) {
                 const title = details.title || details.name, year = new Date(details.release_date || details.first_air_date).getFullYear() || 'N/A';
                 const posterUrl = details.poster_path ? `https://image.tmdb.org/t/p/w500${details.poster_path}` : 'https://placehold.co/500x750/374151/FFFFFF?text=No+Image';
                 const isFavorite = state.favorites.some(fav => fav.id === details.id);
                 const providers = details['watch/providers']?.results?.US?.flatrate || [];
                 let providersHtml = '<p class="text-zinc-400">Not available for streaming.</p>';
                 if (providers.length > 0) {
                     providersHtml = providers.map(p => `<div class="flex items-center space-x-2 p-2 rounded ${state.subscriptions.includes(p.provider_id) ? 'bg-green-800' : 'bg-zinc-700'}"><img src="https://image.tmdb.org/t/p/w92${p.logo_path}" class="w-8 h-8 rounded" alt="${p.provider_name}"><span>${p.provider_name} ${state.subscriptions.includes(p.provider_id) ? '<span class="text-xs text-green-300">(Subscribed)</span>' : ''}</span></div>`).join('');
                 }
                 
                let manualTimeHtml = '';
                const mediaType = details.title ? 'movie' : 'tv';
                if (mediaType === 'tv') {
                    const favorite = state.favorites.find(f => f.id === details.id);
                    if (favorite) {
                        manualTimeHtml = `
                            <div class="mt-4 pt-4 border-t border-zinc-700">
                                <h3 class="text-xl font-semibold mb-2">Manual Air Time</h3>
                                <p class="text-zinc-400 text-sm mb-2">Set a time to help sort your schedule (e.g., "9:00 PM EST").</p>
                                <div id="manualTimeContainer" class="flex items-center space-x-4">
                                    <p id="manualTimeDisplay" class="text-zinc-300 flex-grow">${favorite.manualTime || 'Not set'}</p>
                                    <button id="editTimeButton" class="bg-zinc-600 hover:bg-zinc-500 text-white font-bold py-1 px-3 rounded text-sm">Edit</button>
                                </div>
                            </div>`;
                    }
                }
                 
                 modalContent.innerHTML = `<button id="closeModal" class="absolute top-4 right-4 text-zinc-400 hover:text-white text-3xl leading-none">&times;</button><div class="flex flex-col md:flex-row gap-6"><div class="md:w-1/3 flex-shrink-0"><img src="${posterUrl}" alt="${title}" class="w-full rounded-lg shadow-md"></div><div class="md:w-2/3"><h2 class="text-3xl font-bold mb-2">${title} (${year})</h2><p class="text-zinc-400 mb-4 text-sm">${details.overview || 'No overview.'}</p><button id="favoriteButton" class="w-full mb-6 ${isFavorite ? 'bg-red-600 hover:bg-red-700' : 'bg-zinc-700 hover:bg-zinc-600'} text-white font-bold py-2 px-4 rounded transition">${isFavorite ? 'Remove from Favorites' : 'Add to Favorites'}</button><h3 class="text-xl font-semibold mb-2">Watch On:</h3><div class="flex flex-wrap gap-2 mb-6">${providersHtml}</div>${manualTimeHtml}</div></div>`;
                 
                 const favoriteButton = $('favoriteButton');
                 if(favoriteButton) favoriteButton.addEventListener('click', () => toggleFavorite(details));
                 
                 const editTimeButton = $('editTimeButton');
                 if(editTimeButton) editTimeButton.addEventListener('click', () => editManualTime(details));

                 modal.classList.remove('hidden');
                 const closeModalBtn = $('closeModal');
                 if(closeModalBtn) closeModalBtn.addEventListener('click', closeModal);
            }

            function editManualTime(details) {
                const favorite = state.favorites.find(f => f.id === details.id);
                if (!favorite) return;

                const container = $('manualTimeContainer');
                container.innerHTML = `
                    <div class="flex-grow">
                        <input type="text" id="timeInput" class="w-full bg-zinc-700 border border-zinc-600 rounded-md py-1 px-2 text-white" value="${favorite.manualTime || ''}" placeholder="e.g., 9:00 PM EST">
                    </div>
                    <div class="flex space-x-2">
                        <button id="saveTimeButton" class="bg-zinc-700 hover:bg-zinc-600 text-white font-bold py-1 px-3 rounded text-sm">Save</button>
                        <button id="cancelTimeButton" class="bg-zinc-600 hover:bg-zinc-500 text-white font-bold py-1 px-3 rounded text-sm">Cancel</button>
                    </div>
                `;

                $('saveTimeButton').addEventListener('click', () => {
                    const newTime = $('timeInput').value.trim();
                    const favIndex = state.favorites.findIndex(f => f.id === details.id);
                    if (favIndex > -1) {
                        state.favorites[favIndex].manualTime = newTime;
                    }
                    saveDataToFirestore();
                    renderModal(details); 
                });
                $('cancelTimeButton').addEventListener('click', () => renderModal(details));
            }

            function parseTimeToMinutes(timeString) {
                if (!timeString || typeof timeString !== 'string') return 9999; 
                const time = timeString.toLowerCase().trim();
                let hours = 0;
                let minutes = 0;
                const match = time.match(/(\d{1,2}):?(\d{2})?\s*(am|pm)?/);
                if (match) {
                    hours = parseInt(match[1], 10);
                    minutes = match[2] ? parseInt(match[2], 10) : 0;
                    const period = match[3];
                    if (period === 'pm' && hours < 12) hours += 12;
                    if (period === 'am' && hours === 12) hours = 0;
                }
                return hours * 60 + minutes;
            }

            async function searchMedia(query, isLiveSearch = false) {
                if (!query) { liveSearchResults.classList.add('hidden'); return; }
                if(!isLiveSearch) showLoading();
                try {
                    const data = await apiFetch(`search/multi?query=${query}`);
                    if (isLiveSearch) {
                        renderLiveSearchResults(data.results);
                    } else {
                        renderSearchResults(data.results);
                    }
                } catch (error) {
                    console.error('Search failed:', error);
                    if (!isLiveSearch) {
                        searchResultsMessage.textContent = "Search failed. Please try again.";
                        searchResultsMessage.classList.remove('hidden');
                    }
                } finally {
                    if(!isLiveSearch) hideLoading();
                }
            }

            async function getMediaDetails(id, type) {
                showLoading();
                try {
                    const data = await apiFetch(`${type}/${id}?append_to_response=watch/providers,credits`);
                    renderModal(data);
                } catch (error) {
                    console.error('Failed to get details:', error);
                } finally {
                    hideLoading();
                }
            }

            async function renderFavorites() {
                favoritesViewControls.classList.toggle('hidden', state.isManagingFavorites);
                favoritesManageControls.classList.toggle('hidden', !state.isManagingFavorites);
                
                favoritesMessage.classList.toggle('hidden', state.favorites.length > 0);
                if (state.favorites.length === 0) {
                    favoritesContainer.innerHTML = '';
                    favoritesListContainer.innerHTML = '';
                    return;
                }
                const sortedFavorites = [...state.favorites].sort((a, b) => (a.title || a.name).localeCompare(b.title || b.name));

                if (state.favoritesView === 'grid') {
                    favoritesContainer.classList.remove('hidden');
                    favoritesListContainer.classList.add('hidden');
                    favoritesContainer.innerHTML = '';
                    sortedFavorites.forEach(item => favoritesContainer.appendChild(createMediaCard(item, state.isManagingFavorites)));
                } else {
                    favoritesContainer.classList.add('hidden');
                    favoritesListContainer.classList.remove('hidden');
                    await renderFavoritesList(sortedFavorites); // Manage mode not supported for list yet
                }
                updateSelectedCount();
            }
            
            async function renderFavoritesList(sortedFavorites) {
                const container = favoritesListContainer;
                container.innerHTML = '';
                showLoading();
                try {
                    const providerPromises = sortedFavorites.map(fav => apiFetch(`${fav.media_type}/${fav.id}?append_to_response=watch/providers`));
                    const favoritesWithDetails = await Promise.all(providerPromises);

                    favoritesWithDetails.forEach(details => {
                        const title = details.title || details.name;
                        const posterUrl = details.poster_path ? `https://image.tmdb.org/t/p/w92${details.poster_path}` : 'https://placehold.co/92x138/374151/FFFFFF?text=N/A';
                        const providers = details['watch/providers']?.results?.US?.flatrate || [];
                        let providersHtml = '<span class="text-zinc-400 text-sm">Not on streaming</span>';
                        if (providers.length > 0) {
                            providersHtml = providers.map(p => `<img src="https://image.tmdb.org/t/p/w92${p.logo_path}" class="h-8 w-8 rounded-md object-cover" title="${p.provider_name}">`).join('');
                        }
                        const listItem = document.createElement('div');
                        listItem.className = 'flex items-center space-x-4 p-3 bg-zinc-800 rounded-lg cursor-pointer hover:bg-zinc-700';
                        listItem.innerHTML = `
                            <img src="${posterUrl}" class="w-12 h-auto rounded-md flex-shrink-0">
                            <div class="flex-grow min-w-0"><p class="font-bold truncate">${title}</p></div>
                            <div class="flex flex-wrap gap-2 justify-end items-center flex-shrink" style="max-width: 50%;">${providersHtml}</div>
                        `;
                        listItem.addEventListener('click', () => getMediaDetails(details.id, details.title ? 'movie' : 'tv'));
                        container.appendChild(listItem);
                    });
                } catch (error) {
                    console.error("Error fetching favorites details:", error);
                    container.innerHTML = `<p class="text-center text-red-400">Could not load details.</p>`;
                } finally {
                    hideLoading();
                }
            }

            function updateSelectedCount() {
                const selected = favoritesContainer.querySelectorAll('.favorite-card-manage-checkbox:checked');
                $('favoritesSelectedCount').textContent = `${selected.length} selected`;
            }
            
            async function fetchDashboardData() {
                showLoading();
                try {
                    dashboardUserName.textContent = state.userName || 'You';
                    const trendingPromise = apiFetch(`trending/all/day`);
                    const upcomingPromise = apiFetch(`movie/upcoming`);
                    const [trendingData, upcomingData] = await Promise.all([trendingPromise, upcomingPromise, fetchScheduleData(true)]);
                    
                    renderDashboardTrending(trendingData.results);
                    renderDashboardUpcomingMovies(upcomingData.results);
                    renderDashboardUpcoming();
                } catch (error) {
                    console.error("Failed to load dashboard:", error);
                    upcomingContainer.innerHTML = `<p class="text-zinc-500 text-sm">Could not load dashboard data.</p>`;
                    trendingContainer.innerHTML = '';
                    upcomingMoviesContainer.innerHTML = '';
                } finally {
                    hideLoading();
                }
            }
            
            function renderDashboardTrending(items = []) {
                trendingContainer.innerHTML = '';
                if(items.length === 0) { return; }
                items.filter(item => item.poster_path).forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'flex-shrink-0 w-32 cursor-pointer';
                    card.innerHTML = `<img src="https://image.tmdb.org/t/p/w342${item.poster_path}" class="rounded-lg"><p class="text-sm mt-2 truncate">${item.title || item.name}</p>`;
                    card.addEventListener('click', () => getMediaDetails(item.id, item.media_type));
                    trendingContainer.appendChild(card);
                });
            }

            function renderDashboardUpcomingMovies(items = []) {
                upcomingMoviesContainer.innerHTML = '';
                if(items.length === 0) { return; }
                items.filter(item => item.poster_path).forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'flex-shrink-0 w-32 cursor-pointer';
                    const releaseDate = new Date(item.release_date).toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
                    card.innerHTML = `<img src="https://image.tmdb.org/t/p/w342${item.poster_path}" class="rounded-lg"><p class="text-sm mt-2 truncate">${item.title}</p><p class="text-xs text-zinc-300">${releaseDate}</p>`;
                    card.addEventListener('click', () => getMediaDetails(item.id, 'movie'));
                    upcomingMoviesContainer.appendChild(card);
                });
            }

            function parseLocalDate(dateString) {
                if (!dateString) return null;
                const [year, month, day] = dateString.split('-').map(Number);
                return new Date(year, month - 1, day);
            }
            
            async function fetchScheduleData(isDashboard = false) {
                const favoriteTvShows = state.favorites.filter(fav => fav.media_type === 'tv');
                if (!isDashboard) scheduleMessage.classList.add('hidden');
                
                if (favoriteTvShows.length === 0) {
                    state.scheduledEpisodes = [];
                    return;
                }

                if (!isDashboard) showLoading();
                try {
                    const showDetailPromises = favoriteTvShows.map(show => apiFetch(`tv/${show.id}?append_to_response=watch/providers`));
                    
                    const showDetailResults = await Promise.allSettled(showDetailPromises);
                    const showDetailsList = showDetailResults
                        .filter(result => result.status === 'fulfilled')
                        .map(result => result.value);

                    const seasonPromises = [];
                    for (const showDetail of showDetailsList) {
                        if (showDetail.seasons && Array.isArray(showDetail.seasons)) {
                            // Find the most recent season with a future air date, or the latest overall season
                            const futureSeasons = showDetail.seasons.filter(s => s.air_date && new Date(s.air_date) > new Date());
                            let seasonToFetch = futureSeasons.sort((a,b) => new Date(a.air_date) - new Date(b.air_date))[0];
                            if(!seasonToFetch) {
                                seasonToFetch = showDetail.seasons.filter(s => s.season_number > 0).sort((a, b) => b.season_number - a.season_number)[0];
                            }

                            if (seasonToFetch) {
                                seasonPromises.push(apiFetch(`tv/${showDetail.id}/season/${seasonToFetch.season_number}`).then(seasonData => ({...seasonData, showId: showDetail.id, showName: showDetail.name, showPoster: showDetail.poster_path, networks: showDetail.networks, providers: showDetail['watch/providers'] })));
                            }
                        }
                    }
                    
                    const seasonDetailResults = await Promise.allSettled(seasonPromises);
                    const seasonDetailsList = seasonDetailResults
                        .filter(result => result.status === 'fulfilled')
                        .map(result => result.value);

                    const allEpisodes = [];
                    for (const season of seasonDetailsList) {
                        if (season.episodes) {
                            const us_providers = season.providers?.results?.US?.flatrate || [];
                            const subscribedProvider = us_providers.find(p => state.subscriptions.includes(p.provider_id));
                            let displayNetwork = subscribedProvider ? { name: subscribedProvider.provider_name, logo_path: subscribedProvider.logo_path } : (season.networks && season.networks.length > 0 ? season.networks[0] : null);
                            const episodesWithContext = season.episodes.filter(ep => ep.air_date).map(ep => ({ ...ep, showId: season.showId, showName: season.showName, poster_path: season.showPoster, displayNetwork }));
                            allEpisodes.push(...episodesWithContext);
                        }
                    }
                    state.scheduledEpisodes = allEpisodes;

                } catch (error) {
                    console.error("Error fetching schedule data:", error);
                    if (!isDashboard) {
                        scheduleMessage.textContent = "Could not load schedule data.";
                        scheduleMessage.classList.remove('hidden');
                    }
                    state.scheduledEpisodes = [];
                } finally {
                    if (!isDashboard) hideLoading();
                }
            }
            
            function renderDashboardUpcoming() {
                upcomingContainer.innerHTML = '';
                 const today = new Date(); today.setHours(0,0,0,0);
                 let endDate = new Date(today);
                 if (state.dashboardScheduleFilter === 'today') {} 
                 else if (state.dashboardScheduleFilter === 'week') { endDate.setDate(today.getDate() + 6); } 
                 else if (state.dashboardScheduleFilter === 'month') { endDate.setMonth(today.getMonth() + 1); }

                 const upcoming = state.scheduledEpisodes
                    .map(ep => {
                        const favorite = state.favorites.find(f => f.id === ep.showId);
                        return { ...ep, manualTime: favorite ? favorite.manualTime : null };
                    })
                     .filter(ep => { const airDate = parseLocalDate(ep.air_date); return airDate >= today && airDate <= endDate; })
                     .sort((a,b) => {
                        const dateA = parseLocalDate(a.air_date);
                        const dateB = parseLocalDate(b.air_date);
                        if (dateA.getTime() !== dateB.getTime()) return dateA - dateB;
                        return parseTimeToMinutes(a.manualTime) - parseTimeToMinutes(b.manualTime);
                     });

                 if (upcoming.length === 0) {
                     upcomingContainer.innerHTML = `<p class="text-zinc-500 text-sm">No episodes scheduled for your favorites in this period.</p>`;
                     return;
                 }
                
                upcoming.forEach(ep => {
                    const el = document.createElement('div');
                    el.className = 'flex items-center space-x-4 p-3 bg-zinc-700 rounded-lg';
                    const airDate = parseLocalDate(ep.air_date);
                    const day = airDate.toLocaleDateString(undefined, { weekday: 'short' });
                    const date = airDate.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
                    let networkHtml = '';
                    if (ep.displayNetwork && ep.displayNetwork.logo_path) {
                        networkHtml = `<img src="https://image.tmdb.org/t/p/w92${ep.displayNetwork.logo_path}" class="h-6 object-contain" title="${ep.displayNetwork.name}">`;
                    } else if (ep.displayNetwork) {
                        networkHtml = `<span class="text-xs text-zinc-400">${ep.displayNetwork.name}</span>`;
                    }
                    el.innerHTML = `
                        <div class="text-center w-20 flex-shrink-0">
                            <p class="font-bold text-xl text-zinc-300">${day}</p>
                            <p class="text-sm text-zinc-400">${date}</p>
                        </div>
                        <div class="flex-grow min-w-0">
                            <p class="font-bold">${ep.showName}</p>
                            <p class="text-sm text-zinc-400 truncate">S${ep.season_number} E${ep.episode_number}: ${ep.name}</p>
                            <p class="text-sm font-semibold text-zinc-300 mt-1">${ep.manualTime || ''}</p>
                        </div>
                        <div class="flex flex-col items-center justify-center w-16 flex-shrink-0 space-y-2">
                            <img src="https://image.tmdb.org/t/p/w92${ep.poster_path}" class="w-12 h-auto rounded-md">
                            <div class="h-6 flex items-center justify-center">${networkHtml}</div>
                        </div>`;
                    upcomingContainer.appendChild(el);
                });
            }
            
            function renderSchedule() {
                scheduleMessage.classList.add('hidden');
                if (state.scheduledEpisodes.length === 0) {
                    scheduleMessage.textContent = "No upcoming episodes for your favorite shows.";
                    scheduleMessage.classList.remove('hidden');
                    scheduleContent.innerHTML = '';
                    return;
                }
                if (state.scheduleView === 'calendar') renderCalendar();
                else renderAgenda();
            }

            function renderCalendar() {
                const date = state.currentDate;
                const year = date.getFullYear(), month = date.getMonth();
                const firstDayOfMonth = new Date(year, month, 1);
                const firstDayOfWeek = firstDayOfMonth.getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                
                const monthName = date.toLocaleString('default', { month: 'long' });
                let html = `<div class="p-4"><div class="flex justify-between items-center mb-4"><button id="prevMonth" class="px-2 py-1">&lt;</button><h3 class="text-xl font-semibold">${monthName} ${year}</h3><button id="nextMonth" class="px-2 py-1">&gt;</button></div><div class="grid grid-cols-7 gap-2 text-center text-xs text-zinc-400"><div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div></div><div id="calendarGrid" class="grid grid-cols-7 gap-2 mt-2">`;

                for (let i = 0; i < firstDayOfWeek; i++) { html += `<div></div>`; }
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayDate = new Date(year, month, day);
                    const dayEvents = state.scheduledEpisodes.filter(ep => {
                        const epDate = parseLocalDate(ep.air_date);
                        return epDate && epDate.getTime() === dayDate.getTime();
                    });
                    html += `<div class="p-2 h-20 border border-zinc-700 rounded-md text-xs overflow-hidden ${dayEvents.length > 0 ? 'bg-zinc-900' : ''}"><div class="font-bold">${day}</div><div class="truncate">${dayEvents.map(e => e.showName).join(', ')}</div></div>`;
                }
                html += `</div></div>`;
                scheduleContent.innerHTML = html;
                $('prevMonth').addEventListener('click', () => { state.currentDate.setMonth(month - 1); renderCalendar(); });
                $('nextMonth').addEventListener('click', () => { state.currentDate.setMonth(month + 1); renderCalendar(); });
            }

            function renderAgenda() {
                const sortedEpisodes = [...state.scheduledEpisodes]
                    .map(ep => {
                        const favorite = state.favorites.find(f => f.id === ep.showId);
                        return { ...ep, manualTime: favorite ? favorite.manualTime : null };
                    })
                    .sort((a,b) => {
                        const dateA = parseLocalDate(a.air_date);
                        const dateB = parseLocalDate(b.air_date);
                        if (dateA && dateB && dateA.getTime() !== dateB.getTime()) return dateA - dateB;
                        if (!dateA) return 1;
                        if (!dateB) return -1;
                        return parseTimeToMinutes(a.manualTime) - parseTimeToMinutes(b.manualTime);
                    });

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                scheduleContent.innerHTML = `<div class="space-y-4">${sortedEpisodes.map(ep => {
                    const airDate = parseLocalDate(ep.air_date);
                    if (!airDate) return '';
                    const isPast = airDate < today;
                    let networkHtml = '';
                     if (ep.displayNetwork && ep.displayNetwork.logo_path) { networkHtml = `<img src="https://image.tmdb.org/t/p/w92${ep.displayNetwork.logo_path}" class="h-6 object-contain" alt="${ep.displayNetwork.name}">`; } else if (ep.displayNetwork) { networkHtml = `<span class="text-sm text-zinc-400">${ep.displayNetwork.name}</span>`; }
                    return `<div id="agenda-ep-${ep.id}" class="flex items-center space-x-4 p-3 bg-zinc-700 rounded-lg ${isPast ? 'opacity-50' : ''}"><img src="https://image.tmdb.org/t/p/w92${ep.poster_path}" class="w-12 h-auto rounded-md flex-shrink-0"><div class="flex-grow"><p class="font-bold">${ep.showName}</p><p class="text-sm text-zinc-400">S${ep.season_number} E${ep.episode_number}: ${ep.name}</p></div><div class="text-right flex-shrink-0 w-32"><p class="font-bold text-zinc-300 text-md">${airDate.toLocaleDateString(undefined, { month: 'short', day: 'numeric' })}</p><p class="text-sm text-zinc-300">${ep.manualTime || ''}</p><div class="mt-1 h-6 flex justify-end items-center">${networkHtml}</div></div></div>`;
                }).join('')}</div>`;

                const firstUpcomingIndex = sortedEpisodes.findIndex(ep => {
                    const airDate = parseLocalDate(ep.air_date);
                    return airDate && airDate >= today;
                });

                if (firstUpcomingIndex !== -1) {
                    const firstUpcomingId = sortedEpisodes[firstUpcomingIndex].id;
                    setTimeout(() => {
                        const element = $(`agenda-ep-${firstUpcomingId}`);
                        if (element) {
                            element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }, 100);
                }
            }

            async function refreshCurrentView() {
                // This function is called whenever data changes in Firestore
                updateAccountSection();
                renderSubscriptions();
                dashboardUserName.textContent = state.userName || 'You';
                
                if (state.activeTab === 'dashboard') {
                    await fetchScheduleData(true);
                    renderDashboardUpcoming();
                }
                if (state.activeTab === 'favorites') {
                    await renderFavorites();
                }
                if (state.activeTab === 'schedule') { 
                    await fetchScheduleData(); 
                    renderSchedule(); 
                }
            }


            function showLoading() { $('loadingSpinner').classList.remove('hidden'); }
            function hideLoading() { $('loadingSpinner').classList.add('hidden'); }
            function closeModal() { modal.classList.add('hidden'); }

            async function initAppUI() {
                if (!isDataLoaded) return;
                updateAccountSection();
                renderSubscriptions();
                await switchTab('dashboard');
            }

            function handleFullSearch() {
                const query = searchInput.value.trim();
                liveSearchResults.classList.add('hidden');
                switchTab('search-results');
                searchMedia(query, false);
            }

            let debounceTimer;
            function handleLiveSearch() {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    searchMedia(searchInput.value.trim(), true);
                }, 300);
            }

            function initEventListeners() {
                $('signInWithGoogleButton').addEventListener('click', handleGoogleSignIn);
                
                searchButton.addEventListener('click', handleFullSearch);
                searchInput.addEventListener('input', handleLiveSearch);
                searchInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleFullSearch(); });

                tabs.forEach(tab => tab.addEventListener('click', () => switchTab(tab.dataset.tab)));
                
                favViewBtns.forEach(btn => btn.addEventListener('click', () => {
                    state.favoritesView = btn.dataset.view;
                    favViewBtns.forEach(b => {
                        b.classList.toggle('bg-zinc-900', b === btn);
                        b.classList.toggle('text-white', b === btn);
                        b.classList.toggle('text-zinc-300', b !== btn);
                    });
                    renderFavorites();
                }));
                
                scheduleViewBtns.forEach(btn => btn.addEventListener('click', () => {
                    state.scheduleView = btn.dataset.view;
                    scheduleViewBtns.forEach(b => {
                        b.classList.toggle('bg-zinc-900', b === btn);
                        b.classList.toggle('text-white', b === btn);
                        b.classList.toggle('text-zinc-300', b !== btn);
                    });
                    renderSchedule();
                }));

                upcomingFilterBtns.forEach(btn => btn.addEventListener('click', () => {
                    state.dashboardScheduleFilter = btn.dataset.filter;
                    upcomingFilterBtns.forEach(b => {
                        b.classList.toggle('bg-zinc-900', b === btn);
                        b.classList.toggle('text-white', b === btn);
                        b.classList.toggle('text-zinc-300', b !== btn);
                    });
                    renderDashboardUpcoming();
                }));

                saveUserNameButton.addEventListener('click', () => {
                    if(!userId) { promptForLogin('saving your name'); return; }
                    const name = userNameInput.value.trim();
                    state.userName = name;
                    saveDataToFirestore();
                    userNameMessage.textContent = 'Name saved!';
                    userNameMessage.classList.remove('hidden');
                    setTimeout(() => userNameMessage.classList.add('hidden'), 3000);
                });
                
                themeBtns.forEach(btn => btn.addEventListener('click', () => {
                    state.theme = btn.dataset.theme;
                    applyTheme(state.theme);
                    saveDataToFirestore();
                }));

                // Favorites Management
                $('manageFavoritesBtn').addEventListener('click', () => {
                    state.isManagingFavorites = true;
                    renderFavorites();
                });
                 $('cancelManageFavoritesBtn').addEventListener('click', () => {
                    state.isManagingFavorites = false;
                    renderFavorites();
                });
                $('deleteAllFavoritesBtn').addEventListener('click', () => {
                    showConfirmationModal("Are you sure you want to remove all favorites?", () => {
                        state.favorites = [];
                        saveDataToFirestore();
                    });
                });
                 $('deleteSelectedFavoritesBtn').addEventListener('click', () => {
                    const selected = favoritesContainer.querySelectorAll('.favorite-card-manage-checkbox:checked');
                    if (selected.length === 0) return;
                    const idsToDelete = Array.from(selected).map(el => parseInt(el.value, 10));
                    state.favorites = state.favorites.filter(fav => !idsToDelete.includes(fav.id));
                    saveDataToFirestore();
                });


                scrollLeftBtn.addEventListener('click', () => { trendingContainer.scrollBy({ left: -300, behavior: 'smooth' }); });
                scrollRightBtn.addEventListener('click', () => { trendingContainer.scrollBy({ left: 300, behavior: 'smooth' }); });
                scrollUpcomingLeftBtn.addEventListener('click', () => { upcomingMoviesContainer.scrollBy({ left: -300, behavior: 'smooth' }); });
                scrollUpcomingRightBtn.addEventListener('click', () => { upcomingMoviesContainer.scrollBy({ left: 300, behavior: 'smooth' }); });

                modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
            }

            initEventListeners();
        }

        document.addEventListener('DOMContentLoaded', initializeAppWithConfig);
    </script>
</body>
</html>

